<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KING AI | Premium Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            height: 100dvh;
        }

        #sidebar {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .fixed-input-zone {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 850px;
            z-index: 150; /* Ensure it stays above everything */
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        }

        #chat-window {
            height: 100dvh;
            overflow-y: auto;
            padding-bottom: 160px; /* Space for the floating bar */
            scrollbar-gutter: stable;
        }

        .message-content pre { 
            background: #0f172a !important; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        king: { 600: '#6366f1', 700: '#4f46e5', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-king-950 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div id="loading-overlay" class="fixed inset-0 z-[300] flex items-center justify-center bg-white dark:bg-king-950 text-king-600">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-current border-t-transparent rounded-full animate-spin"></div>
            <p class="font-bold tracking-widest text-xs uppercase">Initializing King AI</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] hidden" onclick="toggleSidebar()"></div>

    <div id="app-root" class="flex h-screen overflow-hidden hidden">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-white dark:bg-king-900 border-r border-slate-200 dark:border-slate-800 flex flex-col -translate-x-full lg:translate-x-0">
            <div class="p-6 border-b dark:border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-king-600 rounded-xl flex items-center justify-center shadow-lg shadow-king-600/30">
                        <i data-lucide="crown" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">KING AI</h1>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Premium Intelligence</p>
                    </div>
                </div>
            </div>

            <div class="p-4 space-y-4">
                <button onclick="createNewChat()" class="w-full flex items-center justify-center gap-2 py-3.5 bg-king-600 hover:bg-king-700 text-white rounded-2xl transition-all font-bold shadow-xl shadow-king-600/20 active:scale-95">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> New Council
                </button>

                <div class="space-y-2">
                    <label class="px-2 text-[10px] font-black uppercase tracking-widest text-slate-400">Intelligence Model</label>
                    <select id="model-select" onchange="updateModelSelection()" class="w-full p-3.5 bg-slate-50 dark:bg-king-950 border border-slate-200 dark:border-slate-800 rounded-xl text-xs font-semibold focus:ring-2 focus:ring-king-600 outline-none">
                        <option value="qwen/qwen3-235b-a22b-thinking-2507">Qwen 3 235B Thinking</option>
                        <option value="stepfun/step-3.5-flash:free">Step 3.5 Flash (Free)</option>
                        <option value="arcee-ai/trinity-large-preview:free">Trinity Large (Free)</option>
                        <option value="sourceful/riverflow-v2-pro">Riverflow V2 Pro</option>
                        <option value="upstage/solar-pro-3:free">Solar Pro 3 (Free)</option>
                        <option value="liquid/lfm-2.5-1.2b-thinking:free">LFM 2.5 Thinking (Free)</option>
                        <option value="black-forest-labs/flux.2-max">Flux.2 Max</option>
                        <option value="nvidia/nemotron-3-nano-30b-a3b:free">Nemotron 3 Nano (Free)</option>
                        <option value="openai/gpt-oss-120b:free">GPT OSS 120B (Free)</option>
                        <option value="z-ai/glm-4.5-air:free">GLM 4.5 Air (Free)</option>
                        <option value="google/gemma-3n-e2b-it:free">Gemma 3N (Free)</option>
                        <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1 (Free)</option>
                        <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (Free)</option>
                    </select>
                </div>
            </div>

            <div id="chat-history" class="flex-1 overflow-y-auto px-4 py-2 space-y-1"></div>

            <div class="p-6 border-t dark:border-slate-800 bg-slate-50/50 dark:bg-king-950/30">
                <button onclick="toggleDarkMode()" class="w-full flex items-center justify-between px-4 py-3 rounded-xl hover:bg-slate-200/50 dark:hover:bg-slate-800 transition-colors">
                    <span class="text-sm font-bold">Display Mode</span>
                    <i data-lucide="moon-star" class="w-5 h-5 text-king-600"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 relative flex flex-col h-screen">
            <nav class="h-16 flex items-center justify-between px-6 bg-white/80 dark:bg-king-950/80 backdrop-blur-xl sticky top-0 z-[80] border-b dark:border-slate-800/50">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="text-center">
                    <p id="current-chat-title" class="font-bold text-sm truncate max-w-[200px]">New Council Session</p>
                    <p id="active-model-tag" class="text-[9px] text-king-600 font-black uppercase tracking-widest">Loading Model...</p>
                </div>
                <div class="w-10"></div>
            </nav>

            <div id="chat-window">
                <div id="welcome-screen" class="min-h-[70vh] flex flex-col items-center justify-center p-8 text-center space-y-6">
                    <div class="w-20 h-20 bg-king-600/10 rounded-3xl flex items-center justify-center animate-bounce">
                        <i data-lucide="sparkles" class="w-10 h-10 text-king-600"></i>
                    </div>
                    <h2 class="text-3xl font-black tracking-tight">System Online</h2>
                    <p class="text-slate-400 text-sm max-w-sm leading-relaxed">Secure API integrated. Select your model from the sidebar to begin processing intelligence.</p>
                </div>
                <div id="messages-list" class="max-w-4xl mx-auto p-4 md:p-8 space-y-10"></div>
            </div>

            <div class="fixed-input-zone">
                <div class="glass-panel rounded-[2rem] p-2 flex items-end gap-2">
                    <button onclick="document.getElementById('file-upload').click()" class="p-4 text-slate-400 hover:text-king-600 transition-all hover:scale-110">
                        <i data-lucide="paperclip" class="w-6 h-6"></i>
                        <input type="file" id="file-upload" class="hidden">
                    </button>
                    
                    <textarea 
                        id="user-input"
                        rows="1"
                        placeholder="Consult King AI..."
                        class="flex-1 bg-transparent py-4 px-2 outline-none resize-none text-[16px] font-medium placeholder:text-slate-400"
                        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
                    ></textarea>

                    <button onclick="handleSendMessage()" class="p-4 bg-king-600 hover:bg-king-700 text-white rounded-[1.5rem] shadow-lg shadow-king-600/30 active:scale-90 transition-all">
                        <i data-lucide="arrow-up" class="w-6 h-6 stroke-[3px]"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // API SECURITY: Key is hardcoded and hidden from user settings UI
        const SECURE_KEY = "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";

        let state = {
            chats: JSON.parse(localStorage.getItem('king_chats_v2') || '[]'),
            currentChatId: null,
            model: localStorage.getItem('king_preferred_model') || 'qwen/qwen3-235b-a22b-thinking-2507',
            darkMode: JSON.parse(localStorage.getItem('king_dark_mode') || 'true')
        };

        window.addEventListener('DOMContentLoaded', () => {
            if (state.darkMode) document.documentElement.classList.add('dark');
            document.getElementById('model-select').value = state.model;
            document.getElementById('active-model-tag').innerText = state.model.split('/')[1] || state.model;
            
            renderHistory();
            if (state.chats.length > 0) loadChat(state.chats[0].id);
            else createNewChat();

            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-root').classList.remove('hidden');
                lucide.createIcons();
            }, 800);
        });

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            const isHidden = sb.classList.contains('-translate-x-full');
            sb.classList.toggle('-translate-x-full', !isHidden);
            ov.classList.toggle('hidden', !isHidden);
        }

        function updateModelSelection() {
            state.model = document.getElementById('model-select').value;
            document.getElementById('active-model-tag').innerText = state.model.split('/')[1] || state.model;
            localStorage.setItem('king_preferred_model', state.model);
        }

        function createNewChat() {
            const id = Date.now().toString();
            state.chats.unshift({ id, title: 'New Council', messages: [] });
            state.currentChatId = id;
            saveState();
            renderHistory();
            renderMessages();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        async function handleSendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            if (chat.title === 'New Council') chat.title = text.slice(0, 30);
            
            input.value = '';
            input.style.height = 'auto';
            renderMessages();
            renderHistory();

            const aiMsg = { role: 'assistant', content: '' };
            chat.messages.push(aiMsg);
            
            const list = document.getElementById('messages-list');
            const aiDiv = document.createElement('div');
            aiDiv.className = "flex justify-start animate-in fade-in duration-500";
            aiDiv.innerHTML = `
                <div class="max-w-[90%] flex gap-4">
                    <div class="w-9 h-9 rounded-xl bg-king-600 text-white flex-shrink-0 flex items-center justify-center shadow-lg"><i data-lucide="crown" class="w-5 h-5"></i></div>
                    <div class="message-content prose dark:prose-invert text-[15px] leading-relaxed pt-1">
                        <div class="flex gap-1"><span class="w-1.5 h-1.5 bg-king-600 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-king-600 rounded-full animate-bounce [animation-delay:0.2s]"></span><span class="w-1.5 h-1.5 bg-king-600 rounded-full animate-bounce [animation-delay:0.4s]"></span></div>
                    </div>
                </div>`;
            list.appendChild(aiDiv);
            const contentContainer = aiDiv.querySelector('.message-content');
            scrollToBottom();
            lucide.createIcons();

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${SECURE_KEY}`, 
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "King AI"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: chat.messages.slice(0, -1),
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                contentContainer.innerHTML = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') break;
                            try {
                                const parsed = JSON.parse(data);
                                const token = parsed.choices[0]?.delta?.content || "";
                                aiMsg.content += token;
                                contentContainer.innerHTML = marked.parse(aiMsg.content);
                                scrollToBottom();
                            } catch (e) {}
                        }
                    }
                }
            } catch (err) { contentContainer.innerText = "Fatal connection error."; }
            finally { saveState(); Prism.highlightAll(); }
        }

        function renderHistory() {
            const container = document.getElementById('chat-history');
            container.innerHTML = state.chats.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="p-3.5 rounded-2xl cursor-pointer text-sm font-semibold transition-all mb-1 ${state.currentChatId === chat.id ? 'bg-king-600/10 text-king-600' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                    <div class="flex items-center gap-3">
                        <i data-lucide="message-square" class="w-4 h-4 opacity-50"></i>
                        <span class="truncate">${chat.title}</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderMessages() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const list = document.getElementById('messages-list');
            const welcome = document.getElementById('welcome-screen');
            if (!chat || chat.messages.length === 0) { list.innerHTML = ''; welcome.classList.remove('hidden'); return; }
            welcome.classList.add('hidden');
            list.innerHTML = chat.messages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[90%] flex gap-4 ${msg.role === 'user' ? 'flex-row-reverse' : ''}">
                        <div class="w-9 h-9 rounded-xl flex-shrink-0 flex items-center justify-center ${msg.role === 'user' ? 'bg-slate-800' : 'bg-king-600'} text-white shadow-lg">
                            <i data-lucide="${msg.role === 'user' ? 'user' : 'crown'}" class="w-5 h-5"></i>
                        </div>
                        <div class="message-content prose dark:prose-invert text-[15px] leading-relaxed pt-1">${marked.parse(msg.content)}</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            scrollToBottom();
            document.getElementById('current-chat-title').innerText = chat.title;
        }

        function loadChat(id) { state.currentChatId = id; renderMessages(); renderHistory(); if(window.innerWidth < 1024) toggleSidebar(); }
        function toggleDarkMode() { state.darkMode = !state.darkMode; document.documentElement.classList.toggle('dark'); localStorage.setItem('king_dark_mode', state.darkMode); }
        function saveState() { localStorage.setItem('king_chats_v2', JSON.stringify(state.chats)); }
        function scrollToBottom() { const c = document.getElementById('chat-window'); c.scrollTo({top: c.scrollHeight, behavior: 'smooth'}); }
    </script>
</body>
</html>
